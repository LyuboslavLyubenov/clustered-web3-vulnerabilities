# Cluster -1322

**Rank:** #200  
**Count:** 56  

## Label
Memory management flaws leading to undefined behavior, data corruption, or state inconsistencies due to improper memory allocation, pointer handling, or failure to distinguish between memory and storage.

## Cluster Information
- **Total Findings:** 56

## Examples

### Example 1

**Auto Label:** Memory layout and alignment misconfigurations leading to data corruption, buffer overflows, and undefined behavior due to improper memory management and unsafe operations.  

**Original Text Preview:**

Throughout the codebase, the following structs use the `InitSpace` macro unnecessarily:

* [`FillV3RelayParams`](https://github.com/across-protocol/contracts/blob/401e24ccca1b3af919dd521e58acd445297b65b6/programs/svm-spoke/src/state/instruction_params.rs#L16)
* [`ExecuteRelayerRefundLeafParams`](https://github.com/across-protocol/contracts/blob/401e24ccca1b3af919dd521e58acd445297b65b6/programs/svm-spoke/src/state/instruction_params.rs#L7)
* [`RequestV3SlowFillParams`](https://github.com/across-protocol/contracts/blob/401e24ccca1b3af919dd521e58acd445297b65b6/programs/svm-spoke/src/state/instruction_params.rs#L24)
* [`ExecuteV3SlowRelayLeafParams`](https://github.com/across-protocol/contracts/blob/401e24ccca1b3af919dd521e58acd445297b65b6/programs/svm-spoke/src/state/instruction_params.rs#L30)

These accounts are initialized using the [`initialize_instruction_params`](https://github.com/across-protocol/contracts/blob/401e24ccca1b3af919dd521e58acd445297b65b6/programs/svm-spoke/src/lib.rs#L589) method, which creates empty accounts with a size specified in the function's instructions. Consequently, the `InitSpace` macro, which implements the `Space` trait, becomes redundant as the `INIT_SPACE` constant generated by this trait is not utilized. The inclusion of the `InitSpace` macro in these cases adds unnecessary overhead and obscures the intended logic, given that its functionality is not employed.

Consider removing the `InitSpace` macro from these structs to simplify the codebase and remove superfluous logic. This adjustment would help improve code clarity and align it more closely with actual use patterns.

***Update:** Resolved in [pull request #839](https://github.com/across-protocol/contracts/pull/839).*

---
### Example 2

**Auto Label:** Memory layout and alignment misconfigurations leading to data corruption, buffer overflows, and undefined behavior due to improper memory management and unsafe operations.  

**Original Text Preview:**

##### Description

In the `directed-stake` program, the `Director` struct is marked with `#[account(zero_copy)]`, but does not appear to enforce a stable memory layout, via `#[repr(C)]` or `#[repr(packed)]`. The same applies to the `DSTInfo` struct in the `directed-stake-token` program (`state.rs`).

  

Without an explicit representation attribute, Rust may introduce unexpected alignment/padding, potentially leading to subtle data corruption or misalignment if the struct is extended or compiled under different settings.

  

Although current versions of the Rust compiler and Anchor typically behave predictably, it is generally recommended to pin down the struct's memory layout when using zero-copy. Failing to do so can become more critical when additional fields are introduced to the struct.

  

* Code excerpts

`directed-stake/programs/directed-stake/src/lib.rs`

```
#[account(zero_copy)]
#[derive(Debug, Default)]
pub struct Director {
    pub stake_target: Pubkey,
    pub last_updated_at: u64,
}
```

  

`directed-stake/programs/directed-stake-token/src/state.rs`

```
#[account(zero_copy)]
#[derive(Debug, Default)]
pub struct DSTInfo {
    /// Mint account of the DST.
    pub token_mint: Pubkey,

    pub operator: Pubkey,
    pub partner: Pubkey,
    /// Where the vSOL tokens are stored.
    /// This also holds all fees.
    /// Note that fees are withdrawn in vSOL-- to withdraw the DST,
    /// chain the withdraw instruction with a mint instruction.
    pub vsol_reserves: Pubkey,

    // The lifetime amount of unclaimed operator fees
    pub lifetime_operator_fees: u64,
    // The total amount of operator fees not withdrawn from the DST.
    pub unclaimed_operator_fees: u64,

    // The lifetime amount of unclaimed partner fees
    pub lifetime_partner_fees: u64,
    // The total amount of partner fees not withdrawn from the DST.
    pub unclaimed_partner_fees: u64,

    /// Bump seed
    pub bump: u8,
    /// Base fee in BPS.
    pub base_fee: u8,
    /// Operator fee in BPS.
    pub operator_fee: u16,
    /// Padding to align the struct
    _padding: u32,

    /// An account which can become the new operator.
    pub pending_operator: Pubkey,
}
```

##### Proof of Concept

**Steps:**

1. Inspect the source code for the `Director` and `DSTInfo` struct definitions.
2. Confirm that `#[repr(C)]` or `#[repr(packed)]` is missing.
3. Optionally, try adding fields or building in a configuration to detect memory alignment/padding issues.

##### BVSS

[AO:A/AC:L/AX:L/R:N/S:C/C:N/A:N/I:L/D:N/Y:N (3.1)](/bvss?q=AO:A/AC:L/AX:L/R:N/S:C/C:N/A:N/I:L/D:N/Y:N)

##### Recommendation

It is recommended to add `#[repr(packed)]` or `#[repr(C)]` directly above any `#[account(zero_copy)]` struct definitions to ensure a stable field layout across all builds.

  

If zero-copy is not strictly required, consider removing `#[account(zero_copy)]` and storing data in a normal Anchor account struct.

##### Remediation Comment

**SOLVED:** The **Vault team** has solved this issue as recommended. The commit hash for reference is `a6f438b20507cb95c079afd2f4305852e5678763`.

##### Remediation Hash

<https://github.com/SolanaVault/directed-stake/commit/a6f438b20507cb95c079afd2f4305852e5678763>

---
### Example 3

**Auto Label:** Memory layout and alignment misconfigurations leading to data corruption, buffer overflows, and undefined behavior due to improper memory management and unsafe operations.  

**Original Text Preview:**

## Code Analysis

The functions `create_account_reliably` and `process_post_message` do not ensure that all the entries of the modified `Vec` were initialized up until the new length before calling `set_len`. According to the functionâ€™s documentation, this is one of the invariants that must be upheld to avoid undefined behavior.

## Code Snippets

### `process_post_message`

```rust
fn process_post_message(accounts: &[AccountInfo]) -> ProgramResult {
    [...]
    unsafe {
        cpi_data.set_len(MAX_CPI_DATA_LEN);
    }
    [...]
}
```
*File: `wormwhole-core-shims/programs/post-message/src/lib.rs`*

### `create_account_reliably`

```rust
fn create_account_reliably(
    [...]
    unsafe {
        core::ptr::write_bytes(cpi_data.as_mut_ptr(), 0, 4);
        cpi_data.set_len(12);
    }
    [...]
    unsafe {
        cpi_data.set_len(MAX_CPI_DATA_LEN);
    }
    [...]
}
```
*File: `wormwhole-core-shims/programs/verify-vaa/src/lib.rs`*

## Remediation

Ensure every entry up until the new length is initialized before calling `set_len`.

## Patch

Partially resolved in commit `32cb65d`.

---
